<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Station m√©t√©o</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(180deg, #020617, #0f172a);
  color: white;
  text-align: center;
  padding: 40px;
}

h1 { font-size: 2.5em; }
h2 { margin-top: 60px; }

.meteo-box {
  background: #1e293b;
  padding: 30px;
  border-radius: 20px;
  width: 360px;
  margin: auto;
}

.big-value {
  font-size: 3.2em;
  font-weight: bold;
}

.sub-value {
  font-size: 1.4em;
  margin: 10px 0;
}

.update {
  font-size: 0.9em;
  opacity: 0.8;
  margin-top: 15px;
}

.alert {
  margin-top: 20px;
  font-size: 1.2em;
  font-weight: bold;
}

canvas {
  width: 100% !important;
  max-width: 1200px;
  height: 420px !important;
  margin: 40px auto;
}

table {
  width: 90%;
  margin: 40px auto;
  border-collapse: collapse;
  background: #1e293b;
}

th, td {
  padding: 10px;
  border-bottom: 1px solid #334155;
}
</style>
</head>

<body>

<h1>üå¶Ô∏è Station m√©t√©o</h1>

<div class="meteo-box">
  <div class="big-value" id="temp">---</div>
  <div class="sub-value" id="hum">---</div>
  <div class="sub-value" id="pres">---</div>
  <div class="update" id="status">Chargement...</div>
  <div class="alert" id="alert">Analyse m√©t√©o...</div>
</div>

<h2>üìà Temp√©rature ‚Äî derni√®res 24h</h2>
<canvas id="chart24h"></canvas>

<h2>üìä Temp√©rature ‚Äî 7 derniers jours</h2>
<canvas id="chart7j"></canvas>

<h2>üìã Historique</h2>
<table>
<thead>
<tr>
<th>Date</th>
<th>Temp√©rature</th>
<th>Humidit√©</th>
<th>Pression</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script>
const url = "https://script.google.com/macros/s/AKfycbzN4vd29mRmM9cnd4_hCjIbyqfooOkAfzYTB9tyKBZBBXfHR2zC_Pp3ngD_DTCF1wDs/exec";

let chart24h = null;
let chart7j = null;

const jours = ["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"];

function formatDate(d){
  return `${jours[d.getDay()]} ${d.getDate().toString().padStart(2,"0")}/${(d.getMonth()+1).toString().padStart(2,"0")}/${d.getFullYear()}`;
}

async function loadData(){
  const res = await fetch(url);
  const raw = await res.json();
  const data = Array.isArray(raw) ? raw : [raw];

  if (data.length < 3) return;

  const now = new Date();
  const last = data[data.length - 1];
  const prev = data[data.length - 2];
  const prev2 = data[data.length - 3];

  // affichage principal
  document.getElementById("temp").textContent = last.temperature + " ¬∞C";
  document.getElementById("hum").textContent = "üíß Humidit√© : " + last.humidity + " %";
  document.getElementById("pres").textContent = "‚è≤Ô∏è Pression : " + last.pressure + " hPa";
  document.getElementById("status").textContent =
    `Derni√®re mise √† jour aujourd‚Äôhui : ${new Date(last.timestamp).toLocaleString()}`;

  // analyse orage (pression)
  const chute = (prev.pressure - last.pressure) + (prev2.pressure - prev.pressure);

  let alertText = "Conditions stables";
  let alertColor = "#22c55e";

  if (chute >= 3) {
    alertText = "üö® Orage tr√®s probable (pression en chute rapide)";
    alertColor = "#ef4444";
  } else if (chute >= 2) {
    alertText = "‚ö†Ô∏è Risque d‚Äôorage dans les prochaines heures";
    alertColor = "#f97316";
  } else if (chute >= 1) {
    alertText = "Instabilit√© atmosph√©rique d√©tect√©e";
    alertColor = "#eab308";
  }

  const alertEl = document.getElementById("alert");
  alertEl.textContent = alertText;
  alertEl.style.color = alertColor;

  // filtres
  const data24h = data.filter(d => now - new Date(d.timestamp) <= 24 * 3600000);
  const data7j = data.filter(d => now - new Date(d.timestamp) <= 7 * 24 * 3600000);

  // graphique 24h
  const labels24h = data24h.map(d => new Date(d.timestamp).toLocaleTimeString());
  const temps24h = data24h.map(d => d.temperature);

  if (!chart24h) {
    chart24h = new Chart(
      document.getElementById("chart24h").getContext("2d"),
      {
        type: "line",
        data: {
          labels: labels24h,
          datasets: [{
            label: "Temp√©rature (¬∞C)",
            data: temps24h,
            borderWidth: 3,
            tension: 0.4
          }]
        }
      }
    );
  } else {
    chart24h.data.labels = labels24h;
    chart24h.data.datasets[0].data = temps24h;
    chart24h.update();
  }

  // graphique 7j
  const labels7j = data7j.map(d => formatDate(new Date(d.timestamp)));
  const temps7j = data7j.map(d => d.temperature);

  if (!chart7j) {
    chart7j = new Chart(
      document.getElementById("chart7j").getContext("2d"),
      {
        type: "line",
        data: {
          labels: labels7j,
          datasets: [{
            label: "Temp√©rature (¬∞C)",
            data: temps7j,
            borderWidth: 3,
            tension: 0.4
          }]
        }
      }
    );
  } else {
    chart7j.data.labels = labels7j;
    chart7j.data.datasets[0].data = temps7j;
    chart7j.update();
  }

  // tableau
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  data7j.slice().reverse().forEach(d => {
    const dt = new Date(d.timestamp);
    tbody.innerHTML += `
      <tr>
        <td>${formatDate(dt)}</td>
        <td>${d.temperature}</td>
        <td>${d.humidity}</td>
        <td>${d.pressure}</td>
      </tr>
    `;
  });
}

loadData();
setInterval(loadData, 60000);
</script>

</body>
</html>
