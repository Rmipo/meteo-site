<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Station mÃ©tÃ©o</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: white;
  text-align: center;
  padding: 30px;
}

h1, h2 {
  margin: 20px 0;
}

.box {
  background: #1e293b;
  padding: 20px;
  border-radius: 12px;
  width: 320px;
  margin: auto;
}

.value {
  font-size: 2em;
  margin-bottom: 10px;
}

canvas {
  max-width: 800px;
  margin: 30px auto;
}

table {
  width: 90%;
  margin: auto;
  border-collapse: collapse;
}

th, td {
  padding: 8px;
  border-bottom: 1px solid #334155;
}
</style>
</head>

<body>

<h1>ğŸŒ¦ï¸ Station mÃ©tÃ©o</h1>

<div class="box">
  <div class="value" id="temp">---</div>
  <div id="hum">---</div>
  <div id="pres">---</div>
  <p id="status">Chargement...</p>
</div>

<h2>ğŸ“ˆ TempÃ©rature â€“ 24 derniÃ¨res heures</h2>
<canvas id="chart24h"></canvas>

<h2>ğŸ“Š TempÃ©rature â€“ 7 derniers jours</h2>
<canvas id="chart7j"></canvas>

<h2>ğŸ“‹ Historique dÃ©taillÃ©</h2>
<table>
<thead>
<tr>
<th>Date</th>
<th>TempÃ©rature (Â°C)</th>
<th>HumiditÃ© (%)</th>
<th>Pression (hPa)</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script>
const url = "https://script.google.com/macros/s/AKfycbzN4vd29mRmM9cnd4_hCjIbyqfooOkAfzYTB9tyKBZBBXfHR2zC_Pp3ngD_DTCF1wDs/exec";

let chart24h = null;
let chart7j = null;

const jours = ["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"];

function formatDate(date) {
  return `${jours[date.getDay()]} ${date.getDate().toString().padStart(2,"0")}/` +
         `${(date.getMonth()+1).toString().padStart(2,"0")}/${date.getFullYear()}`;
}

async function loadData() {
  const res = await fetch(url);
  const data = await res.json();

  const now = new Date();

  // derniÃ¨re valeur
  const last = data[data.length - 1];
  document.getElementById("temp").textContent = last.temperature + " Â°C";
  document.getElementById("hum").textContent = "ğŸ’§ " + last.humidity + " %";
  document.getElementById("pres").textContent = "â²ï¸ " + last.pressure + " hPa";
  document.getElementById("status").textContent =
    "DerniÃ¨re mise Ã  jour : " + new Date(last.timestamp).toLocaleTimeString();

  // filtrage 24h / 7j
  const data24h = data.filter(d =>
    now - new Date(d.timestamp) <= 24 * 60 * 60 * 1000
  );

  const data7j = data.filter(d =>
    now - new Date(d.timestamp) <= 7 * 24 * 60 * 60 * 1000
  );

  // graphique 24h
  const labels24h = data24h.map(d =>
    new Date(d.timestamp).toLocaleTimeString()
  );
  const temp24h = data24h.map(d => d.temperature);

  if (!chart24h) {
    chart24h = new Chart(chart24hCanvas.getContext("2d"), {
      type: "line",
      data: { labels: labels24h, datasets: [{ label: "Â°C", data: temp24h }] }
    });
  } else {
    chart24h.data.labels = labels24h;
    chart24h.data.datasets[0].data = temp24h;
    chart24h.update();
  }

  // graphique 7j
  const labels7j = data7j.map(d =>
    formatDate(new Date(d.timestamp))
  );
  const temp7j = data7j.map(d => d.temperature);

  if (!chart7j) {
    chart7j = new Chart(chart7jCanvas.getContext("2d"), {
      type: "line",
      data: { labels: labels7j, datasets: [{ label: "Â°C", data: temp7j }] }
    });
  } else {
    chart7j.data.labels = labels7j;
    chart7j.data.datasets[0].data = temp7j;
    chart7j.update();
  }

  // tableau
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  data7j.reverse().forEach(d => {
    const date = new Date(d.timestamp);
    tbody.innerHTML += `
      <tr>
        <td>${formatDate(date)}</td>
        <td>${d.temperature}</td>
        <td>${d.humidity}</td>
        <td>${d.pressure}</td>
      </tr>
    `;
  });
}

loadData();
setInterval(loadData, 60000); // 1 minute
</script>

</body>
</html>
