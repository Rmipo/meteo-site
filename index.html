<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Station m√©t√©o</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(180deg, #020617, #0f172a);
  color: white;
  text-align: center;
  padding: 40px;
}

h1 { font-size: 2.5em; }
h2 { margin-top: 60px; }

.meteo-box {
  background: #1e293b;
  padding: 30px;
  border-radius: 20px;
  width: 360px;
  margin: auto;
}

.big-value {
  font-size: 3.2em;
  font-weight: bold;
}

.sub-value {
  font-size: 1.4em;
  margin: 10px 0;
}

.update {
  font-size: 0.9em;
  opacity: 0.8;
  margin-top: 10px;
}

.weather-icon {
  font-size: 3em;
  margin: 10px 0;
}

.alert {
  font-size: 1.3em;
  font-weight: bold;
  margin-top: 10px;
}

.bar {
  width: 100%;
  height: 14px;
  background: #020617;
  border-radius: 8px;
  overflow: hidden;
  margin-top: 10px;
}

.fill {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #22c55e, #eab308, #ef4444);
  transition: width 0.5s;
}

canvas {
  width: 100% !important;
  max-width: 1300px;
  height: 420px !important;
  margin: 40px auto;
}

table {
  width: 90%;
  margin: 40px auto;
  border-collapse: collapse;
  background: #1e293b;
}

th, td {
  padding: 10px;
  border-bottom: 1px solid #334155;
}
</style>
</head>

<body>

<h1>üå¶Ô∏è Station m√©t√©o locale</h1>

<div class="meteo-box">
  <div class="big-value" id="temp">---</div>
  <div class="sub-value" id="hum">---</div>
  <div class="sub-value" id="pres">---</div>

  <div class="weather-icon" id="icon">‚òÄÔ∏è</div>
  <div class="alert" id="alert">Analyse m√©t√©o...</div>

  <div class="bar">
    <div class="fill" id="intensityBar"></div>
  </div>

  <div class="update" id="status">Chargement...</div>
</div>

<h2>üìà Temp√©rature ‚Äî derni√®res 24h</h2>
<canvas id="chart24h"></canvas>

<h2>üìä Temp√©rature ‚Äî 7 derniers jours</h2>
<canvas id="chart7j"></canvas>

<h2>üìã Historique</h2>
<table>
<thead>
<tr>
<th>Date</th>
<th>Temp√©rature</th>
<th>Humidit√©</th>
<th>Pression</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script>
const url = "https://script.google.com/macros/s/AKfycbzN4vd29mRmM9cnd4_hCjIbyqfooOkAfzYTB9tyKBZBBXfHR2zC_Pp3ngD_DTCF1wDs/exec";

async function loadData(){
  const res = await fetch(url);
  const raw = await res.json();
  const data = Array.isArray(raw) ? raw : [raw];
  if (data.length < 3) return;

  const last = data[data.length-1];
  const prev = data[data.length-3];

  document.getElementById("temp").textContent = last.temperature + " ¬∞C";
  document.getElementById("hum").textContent = "üíß Humidit√© : " + last.humidity + " %";
  document.getElementById("pres").textContent = "‚è≤Ô∏è Pression : " + last.pressure + " hPa";
  document.getElementById("status").textContent =
    "Derni√®re mise √† jour aujourd‚Äôhui : " + new Date(last.timestamp).toLocaleString();

  // --- ANALYSE M√âT√âO ---
  const dP = prev.pressure - last.pressure;
  const H = last.humidity;
  const T = last.temperature;

  let score = dP * 40 + H * 0.3 + (T > 20 ? 10 : 0);
  score = Math.max(0, Math.min(100, score));
  document.getElementById("intensityBar").style.width = score + "%";

  let icon = "‚òÄÔ∏è";
  let text = "Beau temps stable";

  if (score > 80) {
    icon = "üå©Ô∏è";
    text = "Orage intense possible";
  } else if (score > 60) {
    icon = "‚õàÔ∏è";
    text = "Orage probable";
  } else if (score > 40) {
    icon = "üåßÔ∏è";
    text = "Pluie possible";
  } else if (score > 25) {
    icon = "üå§Ô∏è";
    text = "Nuages et instabilit√©";
  }

  document.getElementById("icon").textContent = icon;
  document.getElementById("alert").textContent = text;

  // HISTORIQUE
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  data.slice(-50).reverse().forEach(d=>{
    const dt = new Date(d.timestamp);
    tbody.innerHTML += `
      <tr>
        <td>${dt.toLocaleDateString("fr-FR",{weekday:"long",day:"2-digit",month:"2-digit",year:"numeric"})}</td>
        <td>${d.temperature}</td>
        <td>${d.humidity}</td>
        <td>${d.pressure}</td>
      </tr>`;
  });
}

loadData();
setInterval(loadData, 60000);
</script>

</body>
</html>
