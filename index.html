<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Station m√©t√©o</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(180deg, #020617, #0f172a);
  color: white;
  text-align: center;
  padding: 40px;
}

h1 { font-size: 2.5em; }
h2 { margin-top: 60px; }

.meteo-box {
  background: #1e293b;
  padding: 30px;
  border-radius: 20px;
  width: 360px;
  margin: auto;
}

.big-value {
  font-size: 3.2em;
  font-weight: bold;
}

.sub-value {
  font-size: 1.4em;
  margin: 10px 0;
}

.update {
  font-size: 0.9em;
  opacity: 0.8;
  margin-top: 10px;
}

.weather-icon {
  font-size: 3em;
  margin: 10px 0;
}

.alert {
  font-size: 1.3em;
  font-weight: bold;
  margin-top: 10px;
}

.bar {
  width: 100%;
  height: 14px;
  background: #020617;
  border-radius: 8px;
  overflow: hidden;
  margin-top: 10px;
}

.fill {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #22c55e, #eab308, #ef4444);
}

canvas {
  width: 100% !important;
  max-width: 1300px;
  height: 420px !important;
  margin: 40px auto;
}

table {
  width: 90%;
  margin: 40px auto;
  border-collapse: collapse;
  background: #1e293b;
}

th, td {
  padding: 10px;
  border-bottom: 1px solid #334155;
}
</style>
</head>

<body>

<h1>üå¶Ô∏è Station m√©t√©o</h1>

<div class="meteo-box">
  <div class="big-value" id="temp">---</div>
  <div class="sub-value" id="hum">---</div>
  <div class="sub-value" id="pres">---</div>

  <div class="weather-icon" id="icon">‚òÄÔ∏è</div>
  <div class="alert" id="alert">Analyse m√©t√©o...</div>

  <div class="bar">
    <div class="fill" id="intensityBar"></div>
  </div>
  
<div style="margin-top:20px; font-size:0.95em;">
  <div id="stormVector">Vent cellule : --</div>
  <div id="stormArrow" style="font-size:2.2em; margin:5px 0;">‚¨ÜÔ∏è</div>
  <div id="stormETA">Arriv√©e estim√©e (10 km) : --</div>
  <div id="shearInfo">Cisaillement vertical : --</div>
</div>
  
  <div class="update" id="status">Chargement...</div>
</div>

<h2>üìà Temp√©rature ‚Äî derni√®res 24h</h2>
<canvas id="chart24h"></canvas>

<h2>üìä Temp√©rature ‚Äî 7 derniers jours</h2>
<canvas id="chart7j"></canvas>

<h2>üì° Radar pluie temps r√©el</h2>
<iframe 
  width="100%" 
  height="500"
  style="border-radius:15px; margin-top:20px;"
  src="https://www.rainviewer.com/map.html?loc=46.42964,1.83906,8&oFa=1&oC=1&oU=0&oCS=1&oF=0&oAP=1&c=3&o=83&lm=1&layer=radar&sm=1&sn=1">
</iframe>  
  
<h2>üìã Historique</h2>
<table>
<thead>
<tr>
<th>Date</th>
<th>Temp√©rature</th>
<th>Humidit√©</th>
<th>Pression</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script>
const url = "https://script.google.com/macros/s/AKfycbzN4vd29mRmM9cnd4_hCjIbyqfooOkAfzYTB9tyKBZBBXfHR2zC_Pp3ngD_DTCF1wDs/exec";

let chart24h, chart7j;

async function loadData(){
  const res = await fetch(url);
  const raw = await res.json();
  const data = Array.isArray(raw) ? raw : [raw];
  if (data.length < 3) return;

  const last = data[data.length-1];
  const prev = data[data.length-3];

  document.getElementById("temp").textContent = last.temperature + " ¬∞C";
  document.getElementById("hum").textContent = "üíß Humidit√© : " + last.humidity + " %";
  document.getElementById("pres").textContent = "‚è≤Ô∏è Pression : " + last.pressure + " hPa";
  document.getElementById("status").textContent =
    "Derni√®re mise √† jour aujourd‚Äôhui : " + new Date(last.timestamp).toLocaleString();

  // --- ANALYSE ---
  const dP = prev.pressure - last.pressure;
  const score = Math.min(100, Math.max(0, dP * 40 + last.humidity * 0.3));
  document.getElementById("intensityBar").style.width = score + "%";

  let icon="‚òÄÔ∏è", text="Beau temps stable";
  if(score>80){icon="üå©Ô∏è";text="Orage intense possible";}
  else if(score>60){icon="‚õàÔ∏è";text="Orage probable";}
  else if(score>40){icon="üåßÔ∏è";text="Pluie possible";}
  else if(score>25){icon="üå§Ô∏è";text="Instabilit√© l√©g√®re";}
  document.getElementById("icon").textContent=icon;
  document.getElementById("alert").textContent=text;

  const lat = 46.42964;
const lon = 1.83906;

function degToRad(d){return d*Math.PI/180;}
function radToDeg(r){return r*180/Math.PI;}

function vectorAverage(speed1,dir1,speed2,dir2){
  const u1=speed1*Math.cos(degToRad(dir1));
  const v1=speed1*Math.sin(degToRad(dir1));
  const u2=speed2*Math.cos(degToRad(dir2));
  const v2=speed2*Math.sin(degToRad(dir2));
  const u=(u1+u2)/2;
  const v=(v1+v2)/2;
  const speed=Math.sqrt(u*u+v*v);
  let dir=radToDeg(Math.atan2(v,u));
  if(dir<0) dir+=360;
  return {speed,dir};
}

function arrowFromDeg(deg){
  if(deg>=337.5||deg<22.5) return "‚¨ÜÔ∏è";
  if(deg<67.5) return "‚ÜóÔ∏è";
  if(deg<112.5) return "‚û°Ô∏è";
  if(deg<157.5) return "‚ÜòÔ∏è";
  if(deg<202.5) return "‚¨áÔ∏è";
  if(deg<247.5) return "‚ÜôÔ∏è";
  if(deg<292.5) return "‚¨ÖÔ∏è";
  return "‚ÜñÔ∏è";
}

async function loadUpperAtmosphere(){

  const api=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=windspeed_850hPa,winddirection_850hPa,windspeed_700hPa,winddirection_700hPa&forecast_days=1`;

  const res=await fetch(api);
  const data=await res.json();

  const s850=data.hourly.windspeed_850hPa[0];
  const d850=data.hourly.winddirection_850hPa[0];
  const s700=data.hourly.windspeed_700hPa[0];
  const d700=data.hourly.winddirection_700hPa[0];

  const avg=vectorAverage(s850,d850,s700,d700);
  const shear=Math.abs(s700-s850);

  let eta="--";
  if(avg.speed>5){
    const min=Math.round((10/avg.speed)*60);
    eta=min+" min";
  }

  document.getElementById("stormVector").textContent=
    "Vent cellule : "+avg.speed.toFixed(1)+" km/h ("+Math.round(avg.dir)+"¬∞)";

  document.getElementById("stormArrow").textContent=
    arrowFromDeg(avg.dir);

  document.getElementById("stormETA").textContent=
    "Arriv√©e estim√©e : "+eta;

  let shearText="Faible";
  if(shear>30) shearText="Tr√®s fort ‚ö†Ô∏è";
  else if(shear>20) shearText="Fort";
  else if(shear>10) shearText="Mod√©r√©";

  document.getElementById("shearInfo").textContent=
    "Cisaillement : "+shear.toFixed(1)+" km/h ("+shearText+")";
}

loadUpperAtmosphere();
setInterval(loadUpperAtmosphere,300000);
  
  // --- TABLE ---
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML="";
  data.slice(-50).reverse().forEach(d=>{
    const dt=new Date(d.timestamp);
    tbody.innerHTML+=`
    <tr>
      <td>${dt.toLocaleDateString("fr-FR",{weekday:"long",day:"2-digit",month:"2-digit",year:"numeric"})}</td>
      <td>${d.temperature}</td>
      <td>${d.humidity}</td>
      <td>${d.pressure}</td>
    </tr>`;
  });

  // --- GRAPH 24H ---
  const last24h = data.slice(-144);
  const labels24h = last24h.map(d=>new Date(d.timestamp).toLocaleTimeString());
  const temp24h = last24h.map(d=>d.temperature);

  if(chart24h) chart24h.destroy();
  chart24h = new Chart(document.getElementById("chart24h"), {
    type:"line",
    data:{
      labels:labels24h,
      datasets:[{
        label:"Temp√©rature (¬∞C)",
        data:temp24h,
        borderColor:"#38bdf8",
        tension:0.3
      }]
    }
  });

  // --- GRAPH 7J ---
  const last7j = data.slice(-1000);
  const labels7j = last7j.map(d=>new Date(d.timestamp).toLocaleDateString());
  const temp7j = last7j.map(d=>d.temperature);

  if(chart7j) chart7j.destroy();
  chart7j = new Chart(document.getElementById("chart7j"), {
    type:"line",
    data:{
      labels:labels7j,
      datasets:[{
        label:"Temp√©rature (¬∞C)",
        data:temp7j,
        borderColor:"#facc15",
        tension:0.3
      }]
    }
  });
}

loadData();
setInterval(loadData,60000);
</script>

</body>
</html>

