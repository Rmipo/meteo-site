<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Station mÃ©tÃ©o</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(180deg, #020617, #0f172a);
  color: white;
  text-align: center;
  padding: 40px;
}

h1 {
  font-size: 2.5em;
  margin-bottom: 30px;
}

h2 {
  margin-top: 50px;
}

.meteo-box {
  background: #1e293b;
  padding: 30px;
  border-radius: 20px;
  width: 340px;
  margin: auto;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
}

.big-value {
  font-size: 3em;
  font-weight: bold;
}

.sub-value {
  font-size: 1.4em;
  margin: 10px 0;
}

.update {
  font-size: 0.9em;
  opacity: 0.8;
  margin-top: 15px;
}

canvas {
  max-width: 900px;
  margin: 40px auto;
}

table {
  width: 90%;
  margin: 40px auto;
  border-collapse: collapse;
  background: #1e293b;
  border-radius: 10px;
  overflow: hidden;
}

th, td {
  padding: 10px;
  border-bottom: 1px solid #334155;
}

th {
  background: #020617;
}
</style>
</head>

<body>

<h1>ğŸŒ¦ï¸ Station mÃ©tÃ©o</h1>

<div class="meteo-box">
  <div class="big-value" id="temp">---</div>
  <div class="sub-value" id="hum">---</div>
  <div class="sub-value" id="pres">---</div>
  <div class="update" id="status">Chargement...</div>
</div>

<h2>ğŸ“ˆ TempÃ©rature â€” derniÃ¨res 24h</h2>
<canvas id="chart24h"></canvas>

<h2>ğŸ“Š TempÃ©rature â€” 7 derniers jours</h2>
<canvas id="chart7j"></canvas>

<h2>ğŸ“‹ Historique dÃ©taillÃ©</h2>
<table>
<thead>
<tr>
<th>Date</th>
<th>TempÃ©rature (Â°C)</th>
<th>HumiditÃ© (%)</th>
<th>Pression (hPa)</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script>
const url = "https://script.google.com/macros/s/AKfycbzN4vd29mRmM9cnd4_hCjIbyqfooOkAfzYTB9tyKBZBBXfHR2zC_Pp3ngD_DTCF1wDs/exec";

let chart24h = null;
let chart7j = null;

const jours = ["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"];

function formatDate(date) {
  return `${jours[date.getDay()]} ${date.getDate().toString().padStart(2,"0")}/` +
         `${(date.getMonth()+1).toString().padStart(2,"0")}/${date.getFullYear()}`;
}

function formatDateTime(date) {
  return `DerniÃ¨re mise Ã  jour aujourdâ€™hui : ${date.toLocaleDateString()} Ã  ${date.toLocaleTimeString()}`;
}

async function loadData() {
  const res = await fetch(url);
  const raw = await res.json();
  const data = Array.isArray(raw) ? raw : [raw];

  if (data.length === 0) return;

  const now = new Date();
  const last = data[data.length - 1];
  const lastDate = new Date(last.timestamp);

  // affichage principal
  document.getElementById("temp").textContent = last.temperature + " Â°C";
  document.getElementById("hum").textContent = "ğŸ’§ HumiditÃ© : " + last.humidity + " %";
  document.getElementById("pres").textContent = "â²ï¸ Pression : " + last.pressure + " hPa";
  document.getElementById("status").textContent = formatDateTime(lastDate);

  // filtres
  const data24h = data.filter(d => now - new Date(d.timestamp) <= 24*60*60*1000);
  const data7j = data.filter(d => now - new Date(d.timestamp) <= 7*24*60*60*1000);

  // graphique 24h
  const labels24h = data24h.map(d => new Date(d.timestamp).toLocaleTimeString());
  const temp24h = data24h.map(d => d.temperature);

  if (!chart24h) {
    chart24h = new Chart(document.getElementById("chart24h"), {
      type: "line",
      data: {
        labels: labels24h,
        datasets: [{
          label: "TempÃ©rature (Â°C)",
          data: temp24h,
          borderWidth: 3,
          tension: 0.4
        }]
      }
    });
  } else {
    chart24h.data.labels = labels24h;
    chart24h.data.datasets[0].data = temp24h;
    chart24h.update();
  }

  // graphique 7j
  const labels7j = data7j.map(d => formatDate(new Date(d.timestamp)));
  const temp7j = data7j.map(d => d.temperature);

  if (!chart7j) {
    chart7j = new Chart(document.getElementById("chart7j"), {
      type: "line",
      data: {
        labels: labels7j,
        datasets: [{
          label: "TempÃ©rature (Â°C)",
          data: temp7j,
          borderWidth: 3,
          tension: 0.4
        }]
      }
    });
  } else {
    chart7j.data.labels = labels7j;
    chart7j.data.datasets[0].data = temp7j;
    chart7j.update();
  }

  // tableau
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  data7j.slice().reverse().forEach(d => {
    const date = new Date(d.timestamp);
    tbody.innerHTML += `
      <tr>
        <td>${formatDate(date)}</td>
        <td>${d.temperature}</td>
        <td>${d.humidity}</td>
        <td>${d.pressure}</td>
      </tr>
    `;
  });
}

loadData();
setInterval(loadData, 60000);
</script>

</body>
</html>
